# This make must be placed in the target directory which contains the
# cross-compiled intermediate language and assembler files.

# LIBNAME must be set on the command line

CC      := gcc
CM3CG   := cm3cg
CCOPTS  := -fPIC -g
AS      := as #-g
AR      := ar
RANLIB  := ranlib

.PHONY: clean-as clean-obj clean all

FILES_IC := $(wildcard *.ic)
FILES_MC := $(wildcard *.mc)
FILES_IS := $(wildcard *.is)
FILES_MS := $(wildcard *.ms)
FILES_C  := $(wildcard *.c)
FILES_S  := $(wildcard *.s)
BASES_IC := $(basename $(FILES_IC))
BASES_MC := $(basename $(FILES_MC))
BASES_C  := $(basename $(FILES_C) $(FILES_S))
OBJ_IO   := $(addsuffix .io, $(BASES_IC))
OBJ_MO   := $(addsuffix .mo, $(BASES_MC))
OBJ_O    := $(addsuffix .o, $(BASES_C))
OBJECTS  := $(OBJ_IO) $(OBJ_MO) $(OBJ_O)

all: $(LIBNAME)
$(LIBNAME): $(OBJECTS)
	$(AR) cru $(LIBNAME) $(OBJECTS)
	$(RANLIB) $(LIBNAME)

%.o: %.c
	$(CC) $(CCOPTS) -o $@ -c $<

%.o: %.s
	$(AS) -o $@ $<

%.ms: %.mc
	$(CM3CG) $(CCOPTS) -quiet -o $@ $<

%.is: %.ic
	$(CM3CG) $(CCOPTS) -quiet -o $@ $<

%.mo: %.ms
	$(AS) -o $@ $<

%.io: %.is
	$(AS) -o $@ $<

clean-as:
	rm -f $(FILES_IS)
	rm -f $(FILES_MS)

clean-obj:
	rm -f $(OBJ_IO)
	rm -f $(OBJ_MO)
	rm -f $(OBJ_O)
	rm -f $(LIBNAME)

clean: clean-obj clean-as
