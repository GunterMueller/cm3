local readonly proc CM3SetInstallRoot() is
    if defined("INSTALL_ROOT")
        return
    end
    if not equal ($CM3_INSTALL, "")
        INSTALL_ROOT = $CM3_INSTALL
        return
    end
    if not equal ($INSTALLROOT, "")
        INSTALL_ROOT = $INSTALLROOT
        return
    end
    INSTALL_ROOT = (path() & SL & "..")
end

CM3SetInstallRoot()

local readonly proc CM3TargetProbe() is

    if defined("TARGET")
        return
    end

    if not equal($CM3_TARGET, "")
        TARGET = $CM3_TARGET
        return
    end

    if not equal($TARGET, "")
        TARGET = $TARGET
        return
    end

    %
    % more probing here is probably reasonable
    %
    if equal($OS, "Windows_NT")
        TARGET = "NT386"
        return
    end

    error(
        "unable to determine target -- try setting the CM3_TARGET environment variable" & CR
        & "Possible values include FreeBSD4, I386_DARWIN, LINUXLIBC6, NetBSD2_i386, NT386, NT386GNU, PPC_DARWIN, PPC_LINUX, SOLgnu, SPARC"
        )
end

CM3TargetProbe()

local readonly proc CM3ConfigInclude(a) is

    local readonly proc FileExists(a) is
      return not stale (a, a)
    end

    %write("checking " & a & CR)
    if FileExists(a)
        % write("using " & a & CR)
        include(a)
        return TRUE
    end
    return FALSE
end

local readonly proc CM3ConfigProbe() is
    %
    % In order for this file to be useful in a distribution without source, first look near the compiler.
    %
    if (CM3ConfigInclude(path() & SL & "config" & SL & TARGET)
            or CM3ConfigInclude(path() & SL & ".." & SL & TARGET & ".config")
            or CM3ConfigInclude(path() & SL & TARGET & ".cfg")
            or CM3ConfigInclude(path() & SL & TARGET & ".cfg")
            or CM3ConfigInclude(path() & SL & "cm3.exe.config")
            or CM3ConfigInclude(path() & SL & "cm3.config"))
        return
    end
    %
    % Then go to the source tree.
    %
    local readonly proc CM3SetSourceRoot() is
        if defined("ROOT")
            return
        end
        if not equal($CM3_ROOT, "")
            ROOT = $CM3_ROOT
            return
        end
        if not equal($ROOT, "")
            ROOT = $ROOT
            return
        end
        error("Neither the variable ROOT nor environment variables ROOT or CM3_ROOT is defined.")
    end

    CM3SetSourceRoot()

    if CM3ConfigInclude(ROOT & SL & "m3-sys" & SL & "cminstall" & SL & "src" & SL & "config-no-install" & SL & TARGET)
        return
    end

    if CM3ConfigInclude(ROOT & SL & "m3-sys" & SL & "cminstall" & SL & "src" & SL & "config" & SL & TARGET)
        return
    end

    %
    % Give up.
    %
    error("unable to find a configuration file")
end

CM3ConfigProbe()
