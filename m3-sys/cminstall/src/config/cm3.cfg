local readonly proc CM3TargetProbe() is

    if defined("TARGET")
        return
    end

    if not equal($CM3_TARGET, "")
        TARGET = $CM3_TARGET
        return
    end

    if not equal($TARGET, "")
        TARGET = $TARGET
        return
    end

    %
    % more probing here is probably reasonable
    %
    if equal($OS, "Windows_NT")
        TARGET = "NT386"
        return
    end

    error(
        "unable to determine target -- try setting the CM3_TARGET environment variable" & CR
        & "Possible values include FreeBSD4, I386_DARWIN, LINUXLIBC6, NetBSD2_i386, NT386, NT386GNU, PPC_DARWIN, PPC_LINUX, SOLgnu, SPARC"
        )
end

CM3TargetProbe()

local readonly proc CM3ConfigInclude(a) is

    local readonly proc FileExists(a) is
      return not stale (a, a)
    end

    %write("checking " & a & CR)
    if FileExists(a)
        %write("using " & a & CR)
        include(a)
        return TRUE
    end
    return FALSE
end

local readonly proc CM3ConfigProbe() is
    %
    % In order for this file to be useful in a distributation without source, first look near the compiler.
    %
    if (CM3ConfigInclude(path() & "/config/" & TARGET)
            or CM3ConfigInclude(path() & "/../" & TARGET & ".config")
            or CM3ConfigInclude(path() & "/" & TARGET & ".cfg")
            or CM3ConfigInclude(path() & "/" & TARGET & ".cfg")
            or CM3ConfigInclude(path() & "/cm3.exe.config")
            or CM3ConfigInclude(path() & "/cm3.config"))
        return
    end
    %
    % Then go to the source tree.
    %
    if not defined("ROOT")
        if equal($CM3_ROOT, "")
            if equal($ROOT, "")
                error("Neither the variable ROOT nor environment variables ROOT or CM3_ROOT is defined.")
            end
            ROOT = $ROOT
        else
            ROOT = $CM3_ROOT
        end
    end

    if CM3ConfigInclude(ROOT & "/m3-sys/cminstall/src/config-no-install/" & TARGET)
        return
    end

    if CM3ConfigInclude(ROOT & "/m3-sys/cminstall/src/config/" & TARGET)
        return
    end

    %
    % Give up.
    %
    error("unable to find a configuration file")
end

CM3ConfigProbe()
